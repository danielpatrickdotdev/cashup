{% extends "base.html" %}
{% block title %}Tills{% endblock %}
{% block body %}
<script>
$(document).ready(function() {
    // checks if string consists solely of digits (decimals and signs invalid)
    var isNormalInteger = function(str) {
        return /^\d+$/.test(str);
    }
    var recalculateDenomValue = function(denom_input) {
        var count;
        if (isNormalInteger(denom_input.val())) {
            count = parseInt(denom_input.val(), 10);
        } else {
            count = 0;
        }
        var val_span = denom_input.siblings(".denom-value");
        var pval = parseInt(val_span.attr("unit_value"), 10);
        val_span.text((count * pval * 0.01).toFixed(2));
    }
    var recalculateTillTotal = function() {
        var sum = 0.0;
        $(".denom-value").each(function() {
            sum += parseFloat($(this).text()) || 0;
        });
        $("span#till-total-value").text(sum.toFixed(2));
    }
    var recalculateTakingsTotal = function() {
        var total = parseFloat($("input#id_cash_takings").val()) || 0.0;
        total += parseFloat($("input#id_card_takings").val()) || 0.0;
        $("span#total-takings-value").text(total.toFixed(2));
    }
    var recalculateToBankValue = function() {
        var total = parseFloat($(".float-input").val()) || 0.0;
        total += parseFloat($("span#till-total-value").text()) || 0.0;
        $("span#till-to-bank-value").text(total.toFixed(2));
    }
    var refreshDifferenceValue = function() {
        var diff = parseFloat($("span#till-to-bank-value").text()) || 0.0;
        diff -= parseFloat($("span#till-expected-value").text()) || 0.0;
        $("span#till-difference-value").text(diff.toFixed(2));
    }
    var refreshExpectedValue = function() {
        var cash = parseFloat($("input#id_cash_takings").val()) || 0.0;
        $("span#till-expected-value").text(cash.toFixed(2));
    }
    var recalculateAllDenomValues = function() {
        $(".denom-input").each(function() {
            recalculateDenomValue($(this));
        });
    }
    var recalculateAllValues = function() {
        recalculateTakingsTotal();
        recalculateAllDenomValues();
        recalculateTillTotal();
        recalculateToBankValue();
        refreshExpectedValue();
        refreshDifferenceValue();
    }
    var enforce_precision = function(elem) {
        elem.val(parseFloat(elem.val()).toFixed(2));
    }
    // Recalculate takings whenever a cash/card input is changed
    $(".takings-input").change(function() {
        recalculateTakingsTotal();
        enforce_precision($(this));
    });
    // Recalculate whenever float changes
    $(".float-input").change(function() {
        recalculateToBankValue();
        refreshDifferenceValue();
        enforce_precision($(this));
    });
    // Recalculate denoms and figures that depend on them when input is changed
    $(".denom-input").change(function() {
        recalculateDenomValue($(this));
        recalculateTillTotal();
        recalculateToBankValue();
        refreshDifferenceValue();
    });
    // Recalculate expected and difference if cash takings changes
    $(".takings-input#id_cash_takings").change(function() {
        refreshExpectedValue();
        refreshDifferenceValue();
    });
    // Calculate all values on load
    recalculateAllValues();
    // Try to enforce precision on all monetary inputs
    enforce_precision($("input#id_cash_takings"));
    enforce_precision($("input#id_card_takings"));
    enforce_precision($("#float-input"));
});
</script>
        <form action="" method="post" class="form till-closure-form">
            {% csrf_token %}{% if form.non_fields_errors %}
            <div class="non-field-errors">{{ form.non_field_errors }}</div>{% endif %}
            {% for field in form %}
            <div class="form-field" id="{{ field.name }}-form-field">
                <div class="form-field-errors" id="{{ field.name }}-form-field-errors">{% for error in field.errors %}
                    <div>{{ error }}</div>
                {% endfor %}</div>{% if forloop.counter == 1 %}{# till #}
                <label for="{{ field.id_for_label }}">{{ field.label }}:</label>
                <select id="{{ field.id_for_label }}" name="{{ field.name }}" required>{% for value, text in field.field.choices %}
                    <option value="{{ value }}"{% if value == field.value %} selected="selected"{% endif %}>{{ text }}</option>{% endfor %}
                </select>{# /till #}{% elif forloop.counter == 2 %}{# close_time #}
                <label for="{{ field.id_for_label }}">{{ field.label }}:</label>
                <input id="{{ field.id_for_label }}" name="{{ field.name }}" type="text" value="{{ field.value|date:"Y-m-d H:i" }}" required />{# /close_time #}{% elif forloop.counter == 3 %}{# cash_takings #}
                <label for="{{ field.id_for_label }}">{{ field.label }}:</label>
                <input class="takings-input" id="{{ field.id_for_label }}" name="{{ field.name }}" step="0.01" type="number" value="{{ field.value }}" required />{# cash_takings #}{% elif forloop.counter == 4 %}{# card_takings #}
                <label for="{{ field.id_for_label }}">{{ field.label }}:</label>
                <input class="takings-input" id="{{ field.id_for_label }}" name="{{ field.name }}" step="0.01" type="number" value="{{ field.value }}" required />{# card_takings #}
            </div>
            {# total_takings #}<div class="form-field dummy-form-field" id="total-takings-form-field">
                <label for="id_total_takings">Total takings:</label>
                <span id="total-takings-value"></span>{# /total_takings #}{% elif forloop.counter <= 16 %}{# till contents #}
                <input class="denom-input" id="{{ field.id_for_label }}" min="0" name="{{ field.name }}" type="number" value="{{ field.value }}" required />
                <label for="{{ field.id_for_label }}"> x {{ field.label }} = </label>
                <span class="denom-value" id="{{ field.name }}-denom-value" unit_value="{{ field.field.pence_value }}"></span>{# /till contents #}{% endif %}{% if forloop.counter == 16 %}</div>{# till_total #}
            <div class="form-field dummy-form-field" id="till-total-form-field">
                <label for="id_till_total">Till total:</label>
                <span id="till-total-value"></span>{# /till_total #}{% elif forloop.counter == 17 %}{# till_float #}
                <label for="{{ field.id_for_label }}">{{ field.label }}:</label>
                <input class="float-input" id="{{ field.id_for_label }}" name="{{ field.name }}" step="0.01" type="number" value="{{ field.value }}" required />{# /till_float #}
            </div>{# to_bank #}
            <div class="form-field dummy-form-field" id="till-to-bank-form-field">
                <label for="id_till_to_bank">To bank:</label>
                <span id="till-to-bank-value"></span>{# /to_bank #}
            </div>{# expected #}
            <div class="form-field dummy-form-field" id="till-expected-form-field">
                <label for="id_expected">Expected:</label>
                <span id="till-expected-value"></span>{# /expected #}
            </div>{# difference #}
            <div class="form-field dummy-form-field" id="till-difference-form-field">
                <label for="id_difference">Difference:</label>
                <span id="till-difference-value"></span>{# /difference #}{% elif forloop.counter == 18 %}{# notes #}
                <label for="{{ field.id_for_label }}">{{ field.label }}:</label>
                <textarea cols="40" id="{{ field.id_for_label }}" name="{{ field.name }}" rows="10">{% if field.value %}{{ field.value }}{% endif %}</textarea>{# /notes #}{% endif %}
            </div>{% endfor %}
            <input type="submit" value="Save" />
        </form>
    {% endblock %}
